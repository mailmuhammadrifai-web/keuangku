<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keuangku - AI Scanner Ultra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #000; color: white; height: 100dvh; overflow: hidden; }
        #videoFeed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; }
        .mask { position: fixed; inset: 0; z-index: 20; background: rgba(0,0,0,0.6); clip-path: polygon(0% 0%, 0% 100%, 10% 100%, 10% 20%, 90% 20%, 90% 80%, 10% 80%, 10% 100%, 100% 100%, 100% 0%); }
        .scanner-line { position: absolute; top: 20%; left: 10%; width: 80%; height: 4px; background: #22c55e; box-shadow: 0 0 20px #22c55e; z-index: 30; animation: scan 3s infinite ease-in-out; }
        @keyframes scan { 0%, 100% { top: 20%; opacity: 0.3; } 50% { top: 80%; opacity: 1; } }
        .genz-btn { border: 2px solid #000; box-shadow: 4px 4px 0px #000; transition: all 0.1s; }
        .genz-btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px #000; }
    </style>
</head>
<body class="flex flex-col">

    <video id="videoFeed" autoplay playsinline muted></video>
    <canvas id="hiddenCanvas" class="hidden"></canvas>
    
    <div class="mask"></div>
    <div class="scanner-line"></div>

    <header class="fixed top-0 w-full p-6 flex justify-between items-center z-50">
        <a href="index.html" class="bg-white p-3 rounded-2xl border-2 border-black text-black active:scale-90 transition-all shadow-[4px_4px_0px_#000]">
            <i data-lucide="arrow-left" class="w-6 h-6"></i>
        </a>
        <div class="bg-indigo-600 px-4 py-2 rounded-full border-2 border-black flex items-center gap-2 shadow-[4px_4px_0px_#000]">
            <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
            <span class="text-[10px] font-black uppercase tracking-widest">AI Vision 2.0</span>
        </div>
    </header>

    <section class="fixed bottom-0 w-full bg-black/80 backdrop-blur-md p-8 pb-12 flex justify-around items-center z-50 border-t-4 border-white/10 rounded-t-[3rem]">
        <label class="flex flex-col items-center gap-2 cursor-pointer active:scale-90 transition-all text-white/60">
            <input type="file" id="galleryInput" accept="image/*" class="hidden">
            <div class="p-4 bg-white/10 rounded-full border border-white/20"><i data-lucide="image"></i></div>
            <span class="text-[10px] font-bold uppercase">Galeri</span>
        </label>

        <button onclick="captureImage()" class="relative group">
            <div class="w-20 h-20 rounded-full border-4 border-white flex items-center justify-center p-1">
                <div class="w-full h-full rounded-full bg-white border-4 border-black group-active:bg-gray-300"></div>
            </div>
        </button>

        <button onclick="toggleCamera()" class="flex flex-col items-center gap-2 text-white/60 active:scale-90 transition-all">
            <div class="p-4 bg-white/10 rounded-full border border-white/20"><i data-lucide="refresh-cw"></i></div>
            <span class="text-[10px] font-bold uppercase">Putar</span>
        </button>
    </section>

    <div id="aiModal" class="fixed inset-0 bg-black/90 backdrop-blur-xl z-[100] hidden items-center justify-center p-6">
        <div class="bg-white text-black w-full rounded-[2.5rem] p-8 border-4 border-black shadow-[10px_10px_0px_#6366f1]">
            <div id="loader" class="flex flex-col items-center text-center">
                <div class="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h3 class="text-xl font-black uppercase italic italic">AI Lagi Mikir...</h3>
                <p class="text-xs font-bold text-gray-400 mt-2 uppercase">Membaca nominal nota kamu</p>
            </div>

            <div id="result" class="hidden space-y-5">
                <div class="text-center">
                    <div class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-[10px] font-black uppercase border border-green-500 mb-2">Scan Berhasil âœ¨</div>
                    <h3 class="text-3xl font-black italic uppercase tracking-tighter" id="detectedAmount">Rp 0</h3>
                </div>
                
                <div class="bg-gray-100 p-4 rounded-2xl border-2 border-black">
                    <p class="text-[10px] font-black uppercase opacity-40 mb-1">Teks Mentah Terdeteksi:</p>
                    <p id="rawText" class="text-[10px] font-bold h-20 overflow-y-auto leading-tight italic"></p>
                </div>

                <button onclick="window.location.href='index.html'" class="w-full bg-black text-white py-4 rounded-2xl font-black uppercase tracking-widest genz-btn">Simpan ke Laporan</button>
                <button onclick="location.reload()" class="w-full text-xs font-bold uppercase underline text-gray-500">Coba Scan Lagi</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('hiddenCanvas');
        let currentMode = 'environment';

        // 1. Inisialisasi Kamera
        async function initCam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentMode } });
                video.srcObject = stream;
            } catch (err) { alert("Aktifkan izin kamera bosku!"); }
        }

        function toggleCamera() {
            currentMode = currentMode === 'environment' ? 'user' : 'environment';
            initCam();
        }

        // 2. Logika Deteksi Nota (OCR)
        async function runAI(imgSource) {
            document.getElementById('aiModal').classList.replace('hidden', 'flex');
            
            try {
                const worker = await Tesseract.createWorker('ind');
                const { data: { text } } = await worker.recognize(imgSource);
                
                // Regex cerdas untuk mencari angka terbesar (asumsi itu total harga)
                const numbers = text.replace(/[,.]/g, '').match(/\d{4,}/g); 
                let total = numbers ? Math.max(...numbers.map(Number)) : 0;
                
                // Formatting Rupiah
                const formatted = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(total);

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('result').classList.remove('hidden');
                document.getElementById('detectedAmount').innerText = formatted;
                document.getElementById('rawText').innerText = text;
                
                await worker.terminate();
            } catch (e) {
                alert("AI lagi capek, coba foto lebih jelas ya!");
                location.reload();
            }
        }

        // 3. Tombol Jepret
        function captureImage() {
            if (navigator.vibrate) navigator.vibrate(50);
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            runAI(canvas.toDataURL('image/png'));
        }

        // 4. Input Galeri
        document.getElementById('galleryInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (f) => runAI(f.target.result);
            reader.readAsDataURL(e.target.files[0]);
        };

        initCam();
    </script>
</body>
</html>
