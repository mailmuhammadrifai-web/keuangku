<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keuangku - AI Smart Scan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #000; 
            color: white; 
            height: 100dvh; 
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        #videoFeed { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            z-index: 10;
            transform: scaleX(1);
        }
        .viewfinder-mask {
            position: fixed; 
            inset: 0; 
            z-index: 20;
            background: rgba(0,0,0,0.8);
            clip-path: polygon(
                0% 0%, 0% 100%, 
                8% 100%, 8% 15%, 
                92% 15%, 92% 82%, 
                8% 82%, 8% 100%, 
                100% 100%, 100% 0%
            );
        }
        .scanner-line {
            position: absolute; 
            top: 15%; 
            left: 8%; 
            width: 84%; 
            height: 4px;
            background: linear-gradient(90deg, transparent, #22c55e, transparent);
            z-index: 30; 
            animation: scanLoop 2s infinite linear;
            filter: drop-shadow(0 0 8px #22c55e);
        }
        @keyframes scanLoop { 
            0% { top: 15%; }
            100% { top: 82%; }
        }
        .flash-active {
            background: linear-gradient(45deg, #fbbf24, #f59e0b) !important;
            color: white !important;
        }
        .camera-switch {
            transition: transform 0.3s ease;
        }
        .camera-switch:active {
            transform: rotate(180deg);
        }
        .product-item {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="flex flex-col">

    <video id="videoFeed" autoplay playsinline muted></video>
    <canvas id="hiddenCanvas" class="hidden"></canvas>
    <canvas id="preprocessCanvas" class="hidden"></canvas>

    <div class="viewfinder-mask"></div>
    <div class="scanner-line"></div>

    <header class="fixed top-0 w-full p-6 flex justify-between items-center z-50">
        <a href="index.html" class="bg-white p-3 rounded-2xl border-2 border-black text-black shadow-[4px_4px_0px_#000] active:scale-90 transition-all duration-200">
            <i data-lucide="arrow-left"></i>
        </a>
        <button id="flashToggle" class="bg-black/50 backdrop-blur-md p-3 rounded-2xl border-2 border-white/20 text-yellow-300 active:scale-90 shadow-xl transition-all duration-200">
            <i data-lucide="zap-off" id="flashIcon"></i>
        </button>
    </header>

    <section class="fixed bottom-0 w-full bg-gradient-to-t from-black via-black/95 to-transparent backdrop-blur-xl p-8 pb-12 flex justify-around items-center z-50 border-t-4 border-white/10 rounded-t-[3rem]">
        <label class="flex flex-col items-center gap-2 cursor-pointer text-white/50 active:scale-95 transition-transform duration-200">
            <input type="file" id="galleryInput" accept="image/*" class="hidden">
            <div class="p-4 bg-white/10 rounded-full border border-white/20 hover:bg-white/20 transition-colors">
                <i data-lucide="image"></i>
            </div>
            <span class="text-[10px] font-bold uppercase tracking-widest">Galeri</span>
        </label>

        <button onclick="captureImage()" class="relative active:scale-90 transition-transform duration-200">
            <div class="w-24 h-24 rounded-full border-4 border-white flex items-center justify-center p-2 shadow-[0_0_30px_rgba(255,255,255,0.4)]">
                <div class="w-full h-full rounded-full bg-white border-4 border-black"></div>
            </div>
            <div class="absolute inset-0 rounded-full animate-ping bg-white/20 -z-10"></div>
        </button>

        <button onclick="switchCamera()" class="flex flex-col items-center gap-2 text-white/50 camera-switch active:scale-95 transition-transform duration-200">
            <div class="p-4 bg-white/10 rounded-full border border-white/20 hover:bg-white/20 transition-colors">
                <i data-lucide="refresh-cw"></i>
            </div>
            <span class="text-[10px] font-bold uppercase tracking-widest">Putar</span>
        </button>
    </section>

    <!-- AI Processing Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black/95 backdrop-blur-2xl z-[100] hidden items-center justify-center p-6 overflow-y-auto">
        <div class="bg-white text-black w-full max-w-md rounded-[2.5rem] p-8 border-4 border-black shadow-[10px_10px_0px_#6366f1] transform transition-all max-h-[90vh] overflow-y-auto">

            <div id="loadingUI" class="flex flex-col items-center py-10 space-y-6">
                <div class="relative">
                    <div class="w-20 h-20 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                    <div class="absolute inset-0 w-20 h-20 border-4 border-purple-600 border-l-transparent rounded-full animate-spin animation-delay-300"></div>
                </div>
                <div class="text-center">
                    <h3 class="font-black uppercase text-xl italic tracking-tighter bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">AI Sedang Membaca Nota</h3>
                    <p class="text-[11px] font-bold text-gray-400 mt-3 uppercase tracking-wider">Menganalisis detail transaksi...</p>
                    <div class="mt-4 w-48 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div id="progressBar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="resultUI" class="hidden space-y-4">
                <div class="text-center mb-6">
                    <span class="bg-black text-white text-xs font-black px-5 py-2 rounded-full uppercase italic shadow-[3px_3px_0px_#22c55e] inline-flex items-center gap-2">
                        <i data-lucide="check-circle" class="w-4 h-4"></i>
                        Nota Berhasil Dibaca!
                    </span>
                </div>

                <!-- Store Information -->
                <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border-2 border-black">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs font-black uppercase text-blue-600 mb-1 flex items-center gap-2">
                                <i data-lucide="store" class="w-3 h-3"></i>
                                Nama Toko
                            </p>
                            <p id="resStore" class="font-extrabold text-lg uppercase italic leading-tight">---</p>
                            <p id="resAddress" class="text-xs text-gray-600 mt-1">---</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-black uppercase text-blue-600 mb-1">Invoice</p>
                            <p id="resInvoice" class="font-bold text-sm">---</p>
                        </div>
                    </div>
                </div>

                <!-- Transaction Details -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-gray-50 rounded-2xl border-2 border-black">
                        <p class="text-xs font-black uppercase text-gray-400 mb-1 flex items-center gap-2">
                            <i data-lucide="calendar" class="w-3 h-3"></i>
                            Tanggal
                        </p>
                        <p id="resDate" class="font-bold text-sm leading-none">--/--/--</p>
                        <p id="resTime" class="text-[10px] text-gray-500 mt-1">--:--:--</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-2xl border-2 border-black">
                        <p class="text-xs font-black uppercase text-gray-400 mb-1 flex items-center gap-2">
                            <i data-lucide="user" class="w-3 h-3"></i>
                            Kasir
                        </p>
                        <p id="resCashier" class="font-bold text-sm leading-none">---</p>
                        <p id="resCustomerId" class="text-[10px] text-gray-500 mt-1">ID: ---</p>
                    </div>
                </div>

                <!-- Products List -->
                <div id="productsContainer" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Products will be inserted here -->
                </div>

                <!-- Payment Summary -->
                <div class="p-4 bg-gradient-to-br from-yellow-50 to-amber-50 rounded-2xl border-2 border-black shadow-[4px_4px_0px_#000]">
                    <p class="text-xs font-black uppercase text-yellow-700 mb-3 flex items-center gap-2">
                        <i data-lucide="receipt" class="w-3 h-3"></i>
                        Ringkasan Pembayaran
                    </p>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold">Transaksi</span>
                            <span id="resTransaction" class="text-sm font-bold">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold">Biaya Tambahan</span>
                            <span id="resCharge" class="text-sm font-bold">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center border-t border-black/20 pt-2 mt-2">
                            <span class="text-base font-black">Total Bayar</span>
                            <div class="flex items-baseline">
                                <span class="text-sm font-black text-yellow-800">Rp</span>
                                <span id="resTotal" class="text-2xl font-black italic tracking-tighter ml-1">0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-sm font-semibold">Metode</span>
                            <span id="resMethod" class="text-sm font-bold bg-black text-white px-3 py-1 rounded-full">CASH</span>
                        </div>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-sm font-semibold">Kembalian</span>
                            <span id="resChange" class="text-sm font-bold">Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="p-3 bg-red-50 rounded-2xl border-2 border-red-200">
                    <p class="text-[10px] font-black uppercase text-red-600 mb-1">
                        <i data-lucide="alert-triangle" class="w-3 h-3 inline mr-1"></i>
                        Catatan Penting
                    </p>
                    <p id="resNotes" class="text-[10px] text-red-700 leading-tight">
                        * Barang yang sudah dibeli tidak dapat ditukar atau dikembalikan.
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="pt-6 space-y-3">
                    <button onclick="saveTransaction()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-2xl font-black uppercase tracking-widest border-2 border-black shadow-[4px_4px_0px_#000] active:translate-y-1 active:shadow-none transition-all duration-200 hover:opacity-90">
                        Simpan Transaksi
                    </button>
                    <div class="flex gap-3">
                        <button onclick="shareReceipt()" class="flex-1 py-3 text-xs font-black uppercase bg-gray-100 rounded-2xl border-2 border-black active:translate-y-1 transition-all duration-200 flex items-center justify-center gap-2">
                            <i data-lucide="share-2" class="w-4 h-4"></i>
                            Bagikan
                        </button>
                        <button onclick="location.reload()" class="flex-1 py-3 text-xs font-black uppercase text-gray-500 hover:text-black transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                            Scan Lagi
                        </button>
                    </div>
                </div>
            </div>

            <div id="errorUI" class="hidden flex-col items-center py-10 space-y-6">
                <div class="w-20 h-20 rounded-full bg-red-100 flex items-center justify-center">
                    <i data-lucide="alert-circle" class="w-10 h-10 text-red-600"></i>
                </div>
                <div class="text-center">
                    <h3 class="font-black uppercase text-xl text-red-600">Gagal Membaca Nota</h3>
                    <p class="text-sm text-gray-600 mt-2">Pastikan foto terang dan posisi nota tepat dalam kotak scan</p>
                </div>
                <button onclick="location.reload()" class="w-full py-4 bg-black text-white rounded-2xl font-bold uppercase">
                    Coba Lagi
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize icons
        lucide.createIcons();
        
        // DOM Elements
        const video = document.getElementById('videoFeed');
        const canvas = document.getElementById('hiddenCanvas');
        const preprocessCanvas = document.getElementById('preprocessCanvas');
        const progressBar = document.getElementById('progressBar');
        const productsContainer = document.getElementById('productsContainer');
        
        // State variables
        let currentStream = null;
        let isFlashOn = false;
        let isFrontCamera = false;
        let currentFacingMode = 'environment';

        // Initialize camera
        async function initCamera(facingMode = 'environment') {
            try {
                // Stop existing stream
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                // Get camera with better constraints for receipt scanning
                const constraints = {
                    video: {
                        facingMode: facingMode,
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        frameRate: { ideal: 30 }
                    }
                };

                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Apply to video element
                video.srcObject = currentStream;
                
                // Fix for front camera mirroring
                if (facingMode === 'user') {
                    video.style.transform = 'scaleX(-1)';
                } else {
                    video.style.transform = 'scaleX(1)';
                }
                
                await video.play();
                
                // Initialize flash capability if available
                setupFlashCapability();
                
            } catch (error) {
                console.error('Camera error:', error);
                alert("Izin kamera diperlukan untuk menggunakan fitur scan!");
            }
        }

        // Switch between front and back camera
        async function switchCamera() {
            if (navigator.vibrate) navigator.vibrate(30);
            
            isFrontCamera = !isFrontCamera;
            currentFacingMode = isFrontCamera ? 'user' : 'environment';
            
            await initCamera(currentFacingMode);
        }

        // Flash functionality
        async function setupFlashCapability() {
            const flashButton = document.getElementById('flashToggle');
            const flashIcon = document.getElementById('flashIcon');
            
            if (!currentStream) return;
            
            const track = currentStream.getVideoTracks()[0];
            if (!track) return;
            
            try {
                const capabilities = track.getCapabilities ? track.getCapabilities() : {};
                
                if (capabilities.torch) {
                    flashButton.disabled = false;
                    
                    flashButton.onclick = async () => {
                        try {
                            isFlashOn = !isFlashOn;
                            await track.applyConstraints({
                                advanced: [{ torch: isFlashOn }]
                            });
                            
                            flashIcon.setAttribute('data-lucide', isFlashOn ? 'zap' : 'zap-off');
                            flashButton.classList.toggle('flash-active', isFlashOn);
                            lucide.createIcons();
                            
                            if (navigator.vibrate) navigator.vibrate(30);
                        } catch (flashError) {
                            console.error('Flash error:', flashError);
                        }
                    };
                } else {
                    flashButton.disabled = true;
                    flashButton.title = "Flash tidak didukung";
                }
            } catch (error) {
                console.error('Flash setup error:', error);
            }
        }

        // Enhanced Image preprocessing for receipt scanning
        function preprocessImage(imageData) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    // Set canvas size
                    preprocessCanvas.width = img.width;
                    preprocessCanvas.height = img.height;
                    
                    const ctx = preprocessCanvas.getContext('2d');
                    
                    // Create a high contrast version for OCR
                    ctx.filter = 'contrast(1.8) brightness(1.2) grayscale(1)';
                    ctx.drawImage(img, 0, 0, preprocessCanvas.width, preprocessCanvas.height);
                    
                    resolve(preprocessCanvas.toDataURL('image/jpeg', 0.95));
                };
                img.src = imageData;
            });
        }

        // Capture image from camera
        function captureImage() {
            if (!video.srcObject) {
                alert("Kamera belum siap!");
                return;
            }
            
            if (navigator.vibrate) navigator.vibrate(50);
            
            // Set canvas dimensions
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            
            // Draw video frame to canvas
            if (isFrontCamera) {
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
            }
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if (isFrontCamera) {
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            }
            
            // Start OCR processing
            runOcr(canvas.toDataURL('image/jpeg', 0.9));
        }

        // Enhanced OCR processing with specific receipt patterns
        async function runOcr(imageSource) {
            try {
                // Show modal with loading state
                const modal = document.getElementById('aiModal');
                modal.classList.replace('hidden', 'flex');
                document.getElementById('loadingUI').classList.remove('hidden');
                document.getElementById('resultUI').classList.add('hidden');
                document.getElementById('errorUI').classList.add('hidden');
                
                progressBar.style.width = '20%';
                
                // Preprocess image
                const processedImage = await preprocessImage(imageSource);
                progressBar.style.width = '40%';
                
                // Initialize Tesseract with Indonesian language
                const worker = await Tesseract.createWorker('ind', 1, {
                    logger: (m) => {
                        if (m.status === 'recognizing text') {
                            progressBar.style.width = `${40 + (m.progress * 40)}%`;
                        }
                    }
                });
                
                // Configure Tesseract for receipt scanning
                await worker.setParameters({
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.,-/:$()abcdefghijklmnopqrstuvwxyz |',
                    tessedit_pageseg_mode: Tesseract.PSM.AUTO,
                    preserve_interword_spaces: '1',
                });
                
                progressBar.style.width = '60%';
                
                // Perform OCR
                const { data: { text } } = await worker.recognize(processedImage);
                console.log("OCR Raw Text:", text);
                
                progressBar.style.width = '90%';
                
                // Process and extract receipt data
                const receiptData = processReceiptData(text);
                
                // Update UI with results
                updateReceiptUI(receiptData);
                
                progressBar.style.width = '100%';
                
                await worker.terminate();
                
            } catch (error) {
                console.error('OCR Error:', error);
                document.getElementById('loadingUI').classList.add('hidden');
                document.getElementById('errorUI').classList.remove('hidden');
            }
        }

        // Advanced receipt data processing
        function processReceiptData(text) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const textUpper = text.toUpperCase();
            
            console.log("Processing lines:", lines);
            
            const result = {
                store: "PT.AION RITEL PERKASA | CENTRO",
                address: "JL. ANDI DJEMMA, PALOPO",
                invoice: "",
                date: "",
                time: "",
                cashier: "",
                customerId: "",
                products: [],
                transactionAmount: 0,
                charge: 0,
                totalAmount: 0,
                change: 0,
                method: "CASH",
                notes: "* BARANG YANG SUDAH DIBELI TIDAK DAPAT DITUKAR ATAU DIKEMBALIKAN."
            };

            // Extract store information (usually first lines)
            for (let i = 0; i < Math.min(3, lines.length); i++) {
                if (lines[i].includes('PT.') || lines[i].includes('CENTRO') || lines[i].includes('PALOPO')) {
                    result.store = lines[i];
                    if (i + 1 < lines.length && lines[i + 1].includes('JL.')) {
                        result.address = lines[i + 1];
                    }
                    break;
                }
            }

            // Extract invoice and date
            for (const line of lines) {
                // Invoice pattern: INVOICE: 18/0101/231125-029
                if (line.includes('INVOICE:')) {
                    const invoiceMatch = line.match(/INVOICE:\s*([\w\/\-\.]+)/i);
                    if (invoiceMatch) result.invoice = invoiceMatch[1];
                    
                    // Date pattern in same line or next
                    const dateMatch = line.match(/(\d{2}[\/\-]\d{2}[\/\-]\d{4})/);
                    if (dateMatch) result.date = dateMatch[1];
                }
                
                // Separate date extraction
                if (!result.date) {
                    const dateMatch = line.match(/(\d{2}[\/\-]\d{2}[\/\-]\d{4})/);
                    if (dateMatch) result.date = dateMatch[1];
                }
            }

            // Extract cashier and customer ID
            for (const line of lines) {
                if (line.includes('KASIR')) {
                    const cashierMatch = line.match(/KASIR\s*[:=]?\s*([A-Z]+)/i);
                    if (cashierMatch) result.cashier = cashierMatch[1];
                    
                    const custMatch = line.match(/ID\s*CUST\s*[:=]?\s*(\d+)/i);
                    if (custMatch) result.customerId = custMatch[1];
                }
            }

            // Extract products - looking for patterns like "1. 019316: PROBEST"
            const products = [];
            for (let i = 0; i < lines.length; i++) {
                // Product line pattern: starts with number and dot, contains product code
                if (/^\d+\.\s+\d{6}/.test(lines[i]) || 
                    /^\d+\.\s+\d+:/i.test(lines[i])) {
                    
                    // Try to get product name from next line
                    let productName = lines[i];
                    let price = 0;
                    
                    // Look for price in current and next lines
                    for (let j = i; j < Math.min(i + 3, lines.length); j++) {
                        const priceMatch = lines[j].match(/(\d{1,3}(?:\.\d{3})*(?:,\d{2})?)\s*$/);
                        if (priceMatch) {
                            price = parseInt(priceMatch[1].replace(/[^\d]/g, ''));
                            break;
                        }
                    }
                    
                    if (price > 0) {
                        products.push({
                            code: lines[i].match(/\d{6}/)?.[0] || '',
                            name: lines[i].replace(/^\d+\.\s+\d{6}:\s*/i, '').slice(0, 50),
                            price: price
                        });
                    }
                }
            }
            
            result.products = products;

            // Extract amounts with specific patterns from your receipt
            for (const line of lines) {
                const cleanLine = line.replace(/\./g, '').replace(/,/g, '.');
                
                // TRANSAKSI : 69.000,00
                if (line.includes('TRANSAKSI') || line.includes('TRANSACTION')) {
                    const match = cleanLine.match(/TRANSAKSI\s*[:=]?\s*(\d+\.?\d*)/i);
                    if (match) result.transactionAmount = parseFloat(match[1]) * 1000;
                }
                
                // TOT. CHARGE : 0,00
                if (line.includes('CHARGE')) {
                    const match = cleanLine.match(/CHARGE\s*[:=]?\s*(\d+\.?\d*)/i);
                    if (match) result.charge = parseFloat(match[1]) * 1000;
                }
                
                // TOT. BAYAR : 69.000,00
                if (line.includes('BAYAR') || line.includes('TOTAL')) {
                    const match = cleanLine.match(/(?:TOT\.?\s*)?BAYAR\s*[:=]?\s*(\d+\.?\d*)/i);
                    if (match) result.totalAmount = parseFloat(match[1]) * 1000;
                }
                
                // KEMBALIAN : 0,00
                if (line.includes('KEMBALIAN')) {
                    const match = cleanLine.match(/KEMBALIAN\s*[:=]?\s*(\d+\.?\d*)/i);
                    if (match) result.change = parseFloat(match[1]) * 1000;
                }
                
                // DETAIL PEMBAYARAN : TRANSFER BANK = 69.000,00
                if (line.includes('DETAIL PEMBAYARAN')) {
                    if (line.includes('TRANSFER')) result.method = "TRANSFER BANK";
                    else if (line.includes('CASH')) result.method = "CASH";
                    else if (line.includes('DEBIT')) result.method = "DEBIT";
                    else if (line.includes('QR')) result.method = "QRIS";
                }
                
                // TGL. TRX : 23/11/2025 12.09.55
                if (line.includes('TGL. TRX')) {
                    const timeMatch = line.match(/(\d{2}\.\d{2}\.\d{2})/);
                    if (timeMatch) result.time = timeMatch[1].replace(/\./g, ':');
                }
            }

            // Fallback: if amounts not found, calculate from products
            if (result.totalAmount === 0 && products.length > 0) {
                result.totalAmount = products.reduce((sum, product) => sum + product.price, 0);
                result.transactionAmount = result.totalAmount;
            }

            // Fallback: if date not found, use current date
            if (!result.date) {
                const now = new Date();
                result.date = now.toLocaleDateString('id-ID');
            }

            console.log("Processed result:", result);
            return result;
        }

        // Update UI with receipt data
        function updateReceiptUI(data) {
            document.getElementById('loadingUI').classList.add('hidden');
            document.getElementById('resultUI').classList.remove('hidden');

            // Store information
            document.getElementById('resStore').textContent = data.store || "---";
            document.getElementById('resAddress').textContent = data.address || "---";
            document.getElementById('resInvoice').textContent = data.invoice || "---";

            // Transaction details
            document.getElementById('resDate').textContent = data.date || "---";
            document.getElementById('resTime').textContent = data.time || "---";
            document.getElementById('resCashier').textContent = data.cashier || "---";
            document.getElementById('resCustomerId').textContent = `ID: ${data.customerId || "---"}`;

            // Products
            productsContainer.innerHTML = '';
            if (data.products && data.products.length > 0) {
                data.products.forEach((product, index) => {
                    const productElement = document.createElement('div');
                    productElement.className = 'product-item p-3 bg-gray-50 rounded-2xl border-2 border-black';
                    productElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] font-black bg-black text-white px-2 py-0.5 rounded">${index + 1}</span>
                                    <span class="text-xs font-bold text-gray-500">${product.code}</span>
                                </div>
                                <p class="text-sm font-semibold mt-1">${product.name}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-black">Rp ${product.price.toLocaleString('id-ID')}</p>
                                <p class="text-[10px] text-gray-500">1 PCS</p>
                            </div>
                        </div>
                    `;
                    productsContainer.appendChild(productElement);
                });
            } else {
                productsContainer.innerHTML = `
                    <div class="text-center py-4 text-gray-400">
                        <i data-lucide="package" class="w-8 h-8 mx-auto mb-2"></i>
                        <p class="text-sm">Produk tidak terdeteksi</p>
                    </div>
                `;
                lucide.createIcons();
            }

            // Payment summary
            document.getElementById('resTransaction').textContent = `Rp ${(data.transactionAmount || 0).toLocaleString('id-ID')}`;
            document.getElementById('resCharge').textContent = `Rp ${(data.charge || 0).toLocaleString('id-ID')}`;
            document.getElementById('resTotal').textContent = (data.totalAmount || 0).toLocaleString('id-ID');
            document.getElementById('resMethod').textContent = data.method || "CASH";
            document.getElementById('resChange').textContent = `Rp ${(data.change || 0).toLocaleString('id-ID')}`;

            // Notes
            document.getElementById('resNotes').textContent = data.notes || "* Barang yang sudah dibeli tidak dapat ditukar atau dikembalikan.";
        }

        // Handle gallery image selection
        document.getElementById('galleryInput').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert("Ukuran file terlalu besar. Maksimal 10MB");
                e.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                runOcr(event.target.result);
            };
            reader.onerror = () => {
                alert("Gagal membaca file gambar");
            };
            reader.readAsDataURL(file);
            
            // Reset file input
            e.target.value = '';
        };

        // Additional functions
        function saveTransaction() {
            const store = document.getElementById('resStore').textContent;
            const total = document.getElementById('resTotal').textContent;
            
            alert(`Transaksi dari ${store} sebesar Rp ${total} berhasil disimpan!`);
            // Here you would typically save to database or local storage
            // For now, just show alert and redirect
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 1500);
        }

        function shareReceipt() {
            if (navigator.share) {
                navigator.share({
                    title: 'Struk Belanja',
                    text: `Transaksi dari ${document.getElementById('resStore').textContent} sebesar Rp ${document.getElementById('resTotal').textContent}`,
                });
            } else {
                alert("Fitur share tidak didukung di browser ini");
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initCamera();
            
            // Add touch feedback for buttons
            document.querySelectorAll('button, label[for]').forEach(element => {
                element.addEventListener('touchstart', function() {
                    this.classList.add('active:scale-95');
                });
                element.addEventListener('touchend', function() {
                    this.classList.remove('active:scale-95');
                });
            });
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
        });

    </script>
</body>
</html>